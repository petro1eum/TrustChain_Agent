# Vault OSS: объяснение "как ребенку"

## Что вообще происходит

Раньше агент подписывал действия "сам у себя".
Теперь мы вынесли подпись в отдельный сейф (`Vault`).

Простая аналогия:

- `Docker` = защищенная комната, где работает агент.
- `Vault` = сейф с печатью.
- `TrustChain` подпись = оттиск печати на документе.

Комната и сейф нужны одновременно:

- комната защищает исполнение,
- сейф защищает ключ подписи.

## Зачем это нужно

- Ключ подписи не лежит в коде агента и не хранится в `.env` как приватный ключ.
- Даже если у процесса агента проблема, приватный ключ из Vault не "утекает".
- Доказуемость и аудит сильнее: подпись делается отдельным доверенным компонентом.

## Что уже реализовано в проекте

- Есть bridge-сервис `scripts/vault-signer-bridge.mjs`.
- Есть утилита `scripts/vault-key-info.mjs` для `key_id/public_key`.
- Агент умеет работать с внешним signer через `.env`:
  - `VITE_TRUSTCHAIN_EXTERNAL_SIGNER_URL`
  - `VITE_TRUSTCHAIN_EXTERNAL_SIGNER_*`
- Есть preflight-проверка:
  - `npm run trustchain:validate-prod-env`

## Минимальный рабочий путь (5 шагов)

1. Поднять Vault OSS.
2. Создать transit ключ `ed25519`.
3. Получить `key_id/public_key` через `npm run trustchain:vault-key-info`.
4. Запустить bridge `npm run trustchain:vault-bridge`.
5. Включить canary в `.env` и прогнать preflight.

Подробно команды даны в `VAULT_OSS_QUICKSTART.md`.

## Как понять, что все реально работает

- `npm run trustchain:validate-prod-env` возвращает `ok: true`.
- `GET /health` bridge возвращает `ok: true`.
- `POST /sign` bridge возвращает подпись.
- MCP-сервер принимает подпись и не уходит в `deny` по `UNTRUSTED_KEY_ID/UNTRUSTED_PUBKEY`.

## Что это НЕ делает

- Это не "магическая защита от всего".
- Если кто-то получит доступ к `VAULT_TOKEN`, подписью можно злоупотреблять.
- Поэтому в production нужны:
  - отдельный Vault,
  - короткоживущие токены,
  - политики least-privilege,
  - ротация ключей/токенов.

## Когда можно не включать Vault

Для локальной разработки без требований безопасности/аудита можно работать без Vault.
Но для демонстрации "доверенного контура" и production Vault рекомендуется включать.
