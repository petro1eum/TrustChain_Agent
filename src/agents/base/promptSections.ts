/**
 * –ú–æ–¥—É–ª—å–Ω—ã–µ —Å–µ–∫—Ü–∏–∏ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ TrustChain Agent.
 * 
 * –≠—Ç–æ—Ç —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –¢–û–õ–¨–ö–û –ø–ª–∞—Ç—Ñ–æ—Ä–º–æ-–Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–µ —Å–µ–∫—Ü–∏–∏.
 * –ü–ª–∞—Ç—Ñ–æ—Ä–º–æ-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ (–õ–û–ú, —Ä–∏—Å–∫–∏, —Ä–∞–¥–∞—Ä –∏ —Ç.–¥.) –ø—Ä–∏—Ö–æ–¥—è—Ç
 * –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ PanelApp ‚Üí getContextSystemPrompt() ‚Üí MCP tools.
 */

export interface PromptSection {
    id: string;
    title: string;
    /** –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤–∫–ª—é—á–µ–Ω–∏—è —Å–µ–∫—Ü–∏–∏ */
    keywords: string[];
    /** –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –≤—Å–µ–≥–¥–∞ –≤–∫–ª—é—á–∞—Ç—å (core) –∏–ª–∏ —Ç–æ–ª—å–∫–æ –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É (optional) */
    priority: 'core' | 'optional';
    /** –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–µ–∫—Ü–∏–∏ */
    content: string;
}

/**
 * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–∞ –ª–∏ —Å–µ–∫—Ü–∏—è –∑–∞–ø—Ä–æ—Å—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 */
function isSectionRelevant(section: PromptSection, userQuery: string): boolean {
    if (section.priority === 'core') return true;

    const queryLower = userQuery.toLowerCase();
    return section.keywords.some(kw => queryLower.includes(kw.toLowerCase()));
}

/**
 * –°–æ–±–∏—Ä–∞–µ—Ç –ø—Ä–æ–º–ø—Ç –∏–∑ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —Å–µ–∫—Ü–∏–π –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞.
 * –£–º–µ–Ω—å—à–∞–µ—Ç —Ä–∞–∑–º–µ—Ä –ø—Ä–æ–º–ø—Ç–∞ –Ω–∞ 30-60% –¥–ª—è —Ç–∏–ø–∏—á–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.
 */
export function composePromptSections(sections: PromptSection[], userQuery: string): string {
    const relevant = sections.filter(s => isSectionRelevant(s, userQuery));

    return relevant
        .map(s => s.content)
        .join('\n\n');
}

/**
 * –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ —Å–µ–∫—Ü–∏–∏ –¥–ª—è TrustChain Agent.
 * –ü–ª–∞—Ç—Ñ–æ—Ä–º–æ-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏ –∑–Ω–∞–Ω–∏—è –ø—Ä–∏—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ MCP –∏ context prompt.
 */
export function getSmartAgentSections(): PromptSection[] {
    return [
        {
            id: 'identity',
            title: '–ò–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç—å –∞–≥–µ–Ω—Ç–∞',
            keywords: [],
            priority: 'core',
            content: `–¢—ã ‚Äî –º—É–ª—å—Ç–∏-–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω—ã–π AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç TrustChain. –¢—ã –≤—Å—Ç—Ä–∞–∏–≤–∞–µ—à—å—Å—è –≤ —Ä–∞–∑–ª–∏—á–Ω—ã–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã —á–µ—Ä–µ–∑ MCP-–ø—Ä–æ—Ç–æ–∫–æ–ª –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ MCP tools –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã. –û—Ç–≤–µ—á–∞–π —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –∏ –ø–æ –¥–µ–ª—É.`
        },
        {
            id: 'conversation_memory',
            title: '–†–∞–±–æ—Ç–∞ —Å –∏—Å—Ç–æ—Ä–∏–µ–π',
            keywords: ['–æ–±—Å—É–∂–¥–∞–ª–∏', '–ø—Ä–æ–¥–æ–ª–∂', '—Ä–∞–Ω–µ–µ', '–≤—á–µ—Ä–∞', '–ø–æ–º–Ω–∏—à—å', '—É–ø–æ–º–∏–Ω–∞–ª', '–ø—Ä–æ—à–ª', '—á–∞—Ç', '—Ç–æ—Ç', '—Ç–∞ '],
            priority: 'optional',
            content: `# CONVERSATION MEMORY: –†–ê–ë–û–¢–ê –° –ü–†–ï–î–´–î–£–©–ò–ú–ò –î–ò–ê–õ–û–ì–ê–ú–ò

–£ —Ç–µ–±—è –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∏—Å—Ç–æ—Ä–∏–∏ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤ —á–µ—Ä–µ–∑ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫. –ò—Å–ø–æ–ª—å–∑—É–π –µ–≥–æ –¢–û–õ–¨–ö–û –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —è–≤–Ω–æ —Å—Å—ã–ª–∞–µ—Ç—Å—è –Ω–∞ –ø—Ä–æ—à–ª—ã–µ –¥–∏–∞–ª–æ–≥–∏.

## –¢–†–ò–ì–ì–ï–†–´ –î–õ–Ø –ü–û–ò–°–ö–ê –í –ò–°–¢–û–†–ò–ò:
- **–Ø–≤–Ω—ã–µ —Å—Å—ã–ª–∫–∏:** "–ø—Ä–æ–¥–æ–ª–∂–∏ –Ω–∞—à —Ä–∞–∑–≥–æ–≤–æ—Ä –æ...", "—á—Ç–æ –º—ã –æ–±—Å—É–∂–¥–∞–ª–∏...", "–ø–æ–º–Ω–∏—à—å —Ç–æ—Ç..."
- **–í—Ä–µ–º–µ–Ω–Ω—ã–µ —Å—Å—ã–ª–∫–∏:** "–≤—á–µ—Ä–∞ –º—ã –≥–æ–≤–æ—Ä–∏–ª–∏", "–Ω–µ–¥–∞–≤–Ω–æ –æ–±—Å—É–∂–¥–∞–ª–∏", "—Ä–∞–Ω–µ–µ —É–ø–æ–º–∏–Ω–∞–ª"

## –ò–ó–í–õ–ï–ß–ï–ù–ò–ï –ö–õ–Æ–ß–ï–í–´–• –°–õ–û–í:
–ü—Ä–∏ –ø–æ–∏—Å–∫–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ **—Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞** (—Å—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ, —Ç–µ—Ä–º–∏–Ω—ã, –Ω–∞–∑–≤–∞–Ω–∏—è).
**–ò–∑–±–µ–≥–∞–π generic verbs:** –æ–±—Å—É–∂–¥–∞–ª–∏, –≥–æ–≤–æ—Ä–∏–ª, —Å–¥–µ–ª–∞–π, —Å–æ–∑–¥–∞–π, –ø–æ–∫–∞–∂–∏, –Ω–∞–π–¥–∏, –ø–æ–º–æ–≥–∏`
        },
        {
            id: 'workflow',
            title: '–ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è',
            keywords: [],
            priority: 'core',
            content: `# –ö–ê–ö –†–ê–ë–û–¢–ê–¢–¨:

1. **–ü–û–ù–Ø–¢–¨ –ó–ê–ü–†–û–°** ‚Äî –ß—Ç–æ –Ω—É–∂–Ω–æ? –ö–∞–∫–∏–µ –¥–∞–Ω–Ω—ã–µ? –ö–∞–∫–∏–µ MCP tools –¥–æ—Å—Ç—É–ø–Ω—ã?
2. **–ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨ MCP TOOLS** ‚Äî –í—ã–∑–æ–≤–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
3. **–û–¢–í–ï–¢–ò–¢–¨ –ü–û –†–ï–ó–£–õ–¨–¢–ê–¢–ê–ú** ‚Äî –ò—Å–ø–æ–ª—å–∑—É–π –¥–∞–Ω–Ω—ã–µ –∏–∑ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤, –ù–ï —Ñ–∞–Ω—Ç–∞–∑–∏—Ä—É–π
4. **–°–¢–†–£–ö–¢–£–†–ò–†–û–í–ê–¢–¨** ‚Äî –§–∞–∫—Ç—ã ‚Üí –∞–Ω–∞–ª–∏–∑ ‚Üí –≤—ã–≤–æ–¥—ã ‚Üí —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏`
        },
        {
            id: 'charts',
            title: '–ì—Ä–∞—Ñ–∏–∫–∏ –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏',
            keywords: ['–≥—Ä–∞—Ñ–∏–∫', '–¥–∏–∞–≥—Ä–∞–º–º', '–≤–∏–∑—É–∞–ª–∏–∑–∞—Ü', 'chart', '–¥–∞—à–±–æ—Ä–¥'],
            priority: 'optional',
            content: `## üé® –î–õ–Ø –ì–†–ê–§–ò–ö–û–í –ò –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–ô:
create_artifact('chart.html', —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ_HTML) ‚Äî —Å–æ–∑–¥–∞—Ç—å –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫ –∏–ª–∏ –¥–∏–∞–≥—Ä–∞–º–º—É`
        },
        {
            id: 'web_search',
            title: '–í–µ–±-–ø–æ–∏—Å–∫',
            keywords: ['–Ω–∞–π–¥–∏ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç', '–ø–æ–∏—â–∏', 'web', '—Å–∞–π—Ç', 'url', '—Å—Å—ã–ª–∫'],
            priority: 'optional',
            content: `## üåê –î–õ–Ø –í–ï–ë-–ü–û–ò–°–ö–ê:
- web_search(query, maxResults?) ‚Äî –ø–æ–∏—Å–∫ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ
- web_fetch(url) ‚Äî –∑–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
- –í–°–ï–ì–î–ê —Ü–∏—Ç–∏—Ä—É–π –∏—Å—Ç–æ—á–Ω–∏–∫–∏!`
        },
        {
            id: 'code_analysis',
            title: '–ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞',
            keywords: ['–∫–æ–¥', '—Ñ—É–Ω–∫—Ü–∏', '–∫–ª–∞—Å—Å', '–∏–º–ø–æ—Ä—Ç', '–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç', '—Ä–µ—Ñ–∞–∫—Ç–æ—Ä', 'code', 'refactor'],
            priority: 'optional',
            content: `## üß¨ –ê–ù–ê–õ–ò–ó –ö–û–î–ê:
- analyze_code_structure(file_path) ‚Äî –ø–∞—Ä—Å–∏—Ç —Ñ–∞–π–ª, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Ñ—É–Ω–∫—Ü–∏–π, –∫–ª–∞—Å—Å–æ–≤, –∏–º–ø–æ—Ä—Ç–æ–≤
- search_code_symbols(pattern, scope?, symbol_type?) ‚Äî –ø–æ–∏—Å–∫ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π —Å–∏–º–≤–æ–ª–æ–≤
- get_code_dependencies(file_path) ‚Äî –≥—Ä–∞—Ñ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π`
        },
        {
            id: 'final_rules',
            title: '–§–∏–Ω–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞',
            keywords: [],
            priority: 'core',
            content: `# –ö–õ–Æ–ß–ï–í–´–ï –ü–†–ê–í–ò–õ–ê

1. –ß–∏—Ç–∞–π –æ–ø–∏—Å–∞–Ω–∏—è MCP tools ‚Äî —Ç–∞–º –≤—Å—è –Ω—É–∂–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
2. –û—Ç–≤–µ—á–∞–π –ø–æ —Ñ–∞–∫—Ç–∞–º ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π –¥–∞–Ω–Ω—ã–µ –∏–∑ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
3. –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ ‚Äî –ø–æ–ø—Ä–æ–±—É–π –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–æ–¥—Ö–æ–¥
4. –î–ê–í–ê–ô –§–ò–ù–ê–õ–¨–ù–´–ô –û–¢–í–ï–¢ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
5. –°–¢–†–£–ö–¢–£–†–ò–†–£–ô: —Ñ–∞–∫—Ç—ã ‚Üí –∞–Ω–∞–ª–∏–∑ ‚Üí –≤—ã–≤–æ–¥—ã
6. –ù–ï —Å–ø—Ä–∞—à–∏–≤–∞–π "—á—Ç–æ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ" ‚Äî –¥–∞–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç`
        }
    ];
}

/** Backward-compatible alias */
export const SMART_AGENT_SECTIONS = getSmartAgentSections();

/**
 * –°–µ–∫—Ü–∏–∏ –¥–ª—è –±–∞–∑–æ–≤–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ (Docker data processing)
 */
export const BASE_PROMPT_SECTIONS: PromptSection[] = [
    {
        id: 'identity',
        title: '–ò–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç—å',
        keywords: [],
        priority: 'core',
        content: `–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –æ–±—Ä–∞–±–æ—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö –∏ –∞–Ω–∞–ª–∏–∑—É —Å –¥–æ—Å—Ç—É–ø–æ–º –∫ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–º—É Docker –æ–∫—Ä—É–∂–µ–Ω–∏—é. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –ø–æ–º–æ—á—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –¥–∞–Ω–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –∏ —Ç–æ—á–Ω–æ.`
    },
    {
        id: 'principles',
        title: '–ì–ª–∞–≤–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã',
        keywords: [],
        priority: 'core',
        content: `–ì–õ–ê–í–ù–´–ï –ü–†–ò–ù–¶–ò–ü–´:
1. –ü–û–ù–ò–ú–ê–ô –∑–∞–¥–∞—á—É –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Ä–∞–±–æ—Ç—ã
2. –ü–õ–ê–ù–ò–†–£–ô –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–µ–π—Å—Ç–≤–∏–π
3. –ò–°–ü–û–õ–¨–ó–£–ô –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–π –∑–∞–¥–∞—á–∏
4. –ü–†–û–í–ï–†–Ø–ô —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏ –∏—Å–ø—Ä–∞–≤–ª—è–π –æ—à–∏–±–∫–∏
5. –û–ë–™–Ø–°–ù–Ø–ô —á—Ç–æ —Ç—ã –¥–µ–ª–∞–µ—à—å –∏ –ø–æ—á–µ–º—É`
    },
    {
        id: 'docker_env',
        title: '–†–∞–±–æ—á–µ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ',
        keywords: [],
        priority: 'core',
        content: `–†–ê–ë–û–ß–ï–ï –û–ö–†–£–ñ–ï–ù–ò–ï (Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä):
- –†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: /home/kb
- –í–ª–æ–∂–µ–Ω–∏—è –∏–∑ —á–∞—Ç–∞: /mnt/user-data/outputs
- –§–∞–π–ª—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: /mnt/user-data/uploads (read-only)
- –í—ã—Ö–æ–¥–Ω—ã–µ —Ñ–∞–π–ª—ã: /mnt/user-data/outputs (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∫–æ–ø–∏—Ä—É–π —Å—é–¥–∞!)
- Skills: /mnt/skills (read-only)
- –û–∫—Ä—É–∂–µ–Ω–∏–µ: Ubuntu 24.04, gVisor sandbox`
    },
    {
        id: 'critical_rules',
        title: '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞',
        keywords: [],
        priority: 'core',
        content: `–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê:
1. –í–°–ï–ì–î–ê —É–∫–∞–∑—ã–≤–∞–π "description" –¥–ª—è –≤—Å–µ—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
2. pip install –í–°–ï–ì–î–ê —Å --break-system-packages
3. –§–∏–Ω–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã –≤ /mnt/user-data/outputs
4. SKILL.md –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (.docx/.pptx/.xlsx/.pdf)
5. –ü–æ—Ä—è–¥–æ–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ create_file: description ‚Üí path ‚Üí file_text`
    }
];
